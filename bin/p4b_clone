#!/bin/bash

P4BRIDGEDIR=".p4bridge"

read_properties()
{
  file="$1"
  while IFS="=" read -r key value; do
    case "$key" in
      '#'*) ;;
      *)
        eval "$key=\"$value\""
    esac
  done < "$file"
}
P4CLIENTPREFIX=$USER"_"`hostname -s`
P4DEPOT=$1
P4CLIENT=$P4CLIENTPREFIX`echo $P4DEPOT | sed -E "s|(/\|//)|_|g"`
echo $P4CLIENT
mkdir -p $P4BRIDGEDIR
echo "P4CLIENT=$P4CLIENT" > $P4BRIDGEDIR/config
echo "P4DEPOT=$P4DEPOT" >> $P4BRIDGEDIR/config
ROOT=`pwd`/$P4BRIDGEDIR/root
P4DEPOTTRIM=`echo $P4DEPOT | sed "s|//||g"`
echo -e "Client: $P4CLIENT\nRoot: $ROOT\nOwner: $USER\nView:\n\t$P4DEPOT/... //$P4CLIENT/$P4DEPOTTRIM/...\n" | p4 client -i 
p4 sync -f 2>/dev/null
git init .
echo $P4BRIDGEDIR/ >> .git/info/exclude
git checkout -b p4_master
p4b_availchanges $2 | xargs -L1 p4b_getupdate
git checkout .
git checkout -b master
