#!/bin/bash
source p4butils
setdepot

ROOTDIR=$P4BRIDGEDIR/root

p4 sync -f $P4DEPOT/...@`lastp4change` > /dev/null
CURR_BRANCH=`git rev-parse --abbrev-ref HEAD`

git diff-tree --no-commit-id -r -M p4_master $CURR_BRANCH | awk -v dd=$ROOTDIR '$5 ~ /^A/ {print "p4 add "dd"/"$6}; $5 ~ /^M/ {print "p4 edit "dd"/"$6}; $5 ~ /^R.*/ {print "p4 edit "dd"/"$6 "; p4 move "dd"/"$6" "dd"/"$7 } ' | 
								while read -r line 
								do 
									eval $line 
								done
git --work-tree $ROOTDIR checkout . 
