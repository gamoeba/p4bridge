#!/bin/bash
# Check for proper number of command line args.

EXPECTED_ARGS=1
E_BADARGS=65

if [ $# -ne $EXPECTED_ARGS ]
then
  echo "Usage: `basename $0` {changelist-num}"
  exit $E_BADARGS
fi

. p4b_setdepot

export CURR_BRANCH=`git rev-parse --abbrev-ref HEAD`
BASE_CL=`expr $1 - 1`
GITTAG=`p4b_latestchange $BASE_CL`
echo "basing git on tag "$GITTAG
git checkout --detach $GITTAG 2>/dev/null
echo "fetching changelist $DEPOTDIR@$BASE_CL"
p4 sync -f $P4DEPOT"/..."@$BASE_CL
p4 unshelve -s $1
export DESC=`p4b_changedesc $1`
git checkout -b shelved/$1 && 
    git --work-tree $P4BRIDGEDIR/root add --all &&
    git commit -m "Unshelved from $P4DEPOT@$1

$DESC" 
git checkout .
git clean -fd
git checkout $CURR_BRANCH
