#!/bin/bash
function listp4changes()
{
    git log --simplify-by-decoration --decorate --pretty=oneline p4_master | fgrep 'tag: ' | perl -ne '/tag: perforce#(\d+)/ && print "$1\n";' | sort -n -r
}

function lastp4change()
{
    listp4changes | head -n 1
}

function firstp4change()
{
    listp4changes | tail -n 1
}

function limitp4change()
{
    RET=$1
    FIRSTCHANGE=`firstp4change`
    LASTCHANGE=`lastp4change`
    if [[ $1 -gt $LASTP4CHANGE ]]
    then
        RET=$LASTCHANGE
    fi
    if [[ $1 -lt $FIRSTCHANGE ]]
    then
        RET=$FIRSTCHANGE
    fi
    echo $RET
}

function changedate()
{
    p4 change -o $1 | grep ^Date: | sed 's/^Date://' | tr -d '\011'
}

function changedesc()
{
    p4 change -o $1 -L | sed -e '1,/^Description/d' | tr -d '\011'
}

function changecommitter()
{
    p4 change -o $1 | grep ^User: | sed 's/^User://' | tr -d '\011'
}

function useremail()
{
    p4 user -o $1 | grep ^Email: | sed 's/^Email://' | tr -d '\011'
}

function userfullname()
{
    p4 user -o $1 | grep ^FullName: | sed 's/^FullName://' | tr -d '\011'
}

function amendChangelistWithCommitInfo()
{
AUTHOR=`changecommitter $1`
USERNAME=`userfullname $AUTHOR`
USEREMAIL=`useremail $AUTHOR`
AUTHORFMT="$USERNAME < $USEREMAIL >"

DATE=`changedate $1`
DESC="`changedesc $1`
perforce#$1"
if [ ! -z "$2" ]; then
    DESC="$DESC
$2"
fi
git commit --amend -m "$DESC" --author="$AUTHORFMT" --date="$DATE $P4BRIDGE_SERVERTIMEZONE"
}

function setlastp4change()
{
    git tag -af "perforce#$1" -m "p4bridge"
}

function upsearch () {
    test / == "$PWD" && return || test -e "$1" && return || cd .. && upsearch "$1"
}


read_properties()
{
  file="$1"
  while IFS="=" read -r key value; do
    case "$key" in
      '#'*) ;;
      *)
        eval "export $key=\"$value\""
    esac
  done < "$file"
}

function setdepot()
{
    export P4BRIDGEDIR=".p4bridge"
    export P4BRIDGEROOTDIR=$P4BRIDGEDIR"/root"
    upsearch $P4BRIDGEDIR
    read_properties "$P4BRIDGEDIR/config"
}
